name: Update Blog Posts
on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Fetch RSS and update README
        run: |
          curl -sL "https://www.srujangurram.me/feed.xml" -o feed.xml
          
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          from datetime import datetime

          tree = ET.parse('feed.xml')
          root = tree.getroot()
          channel = root.find('channel')
          items = channel.findall('item')[:4]

          posts = []
          for item in items:
              title = item.find('title').text
              link = item.find('link').text
              date = item.find('pubDate').text
              slug = link.rstrip('/').split('/')[-1]
              try:
                  dt = datetime.strptime(date, '%a, %d %b %Y %H:%M:%S %Z')
                  date_str = dt.strftime('%b %d, %Y')
              except:
                  date_str = date
              posts.append((title, link, slug, date_str))

          # Build 2-column table
          rows = []
          for i in range(0, len(posts), 2):
              cells = []
              for j in range(2):
                  if i + j < len(posts):
                      t, l, s, d = posts[i + j]
                      cover = f"https://srujangurram.me/blog/{s}/images/cover.png"
                      cells.append(f'''<td width="50%">
<a href="{l}">
<img src="{cover}" width="100%" alt="{t}" />
</a>
<br/>
<strong><a href="{l}">{t}</a></strong>
<br/>
<sub>{d}</sub>
</td>''')
                  else:
                      cells.append('<td width="50%"></td>')
              rows.append('<tr>\n' + '\n'.join(cells) + '\n</tr>')

          blog_section = '<table>\n' + '\n'.join(rows) + '\n</table>'

          with open('README.md', 'r') as f:
              content = f.read()

          start = '<!-- BLOG:START -->'
          end = '<!-- BLOG:END -->'
          if start in content and end in content:
              before = content[:content.index(start) + len(start)]
              after = content[content.index(end):]
              content = before + '\n' + blog_section + '\n' + after
              with open('README.md', 'w') as f:
                  f.write(content)
              print('Updated blog section')
          EOF
          
          rm -f feed.xml
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet README.md || (git add README.md && git commit -m "üìù update latest blog posts" && git push)
